<article class="chat-container">
  <header class="chat-header">
    <div>
      <h3>Chat - {{ tipo?.nombre || (necesitaAsignarTipo ? 'Sin tipo asignado' : 'Cargando...') }}</h3>
      <p class="chat-cliente">{{ caso.numeroUsuario }}</p>
      @if (asesorAbre) {
        <p class="chat-info-asesor">Caso abierto por: {{ asesorAbre.nombre }}</p>
      }
      @if (modoSoloLectura && asesorCierra) {
        <p class="chat-info-asesor">Caso cerrado por: {{ asesorCierra.nombre }} el {{ formatearFecha(caso.fechaResolucion) }}</p>
      }
    </div>
    <button
      class="btn-cerrar-chat"
      (click)="cerrarChat()"
      aria-label="Cerrar chat">âœ•</button>
  </header>

  <section class="chat-mensajes" #chatMensajes role="log" aria-live="polite">
    @if (cargandoMasMensajes) {
      <div class="loading-indicator" role="status">
        <div class="spinner"></div>
        <span>Cargando mensajes...</span>
      </div>
    }

    @for (mensaje of mensajes; track trackByMensajeId($index, mensaje)) {
      <div
        class="mensaje"
        [class.mensaje-cliente]="mensaje.esRespuesta === false"
        [class.mensaje-agente]="mensaje.esRespuesta === true"
        role="article">
        <div class="mensaje-header">
          <strong class="mensaje-emisor">
            {{ mensaje.esRespuesta === false ? caso.numeroUsuario : 'Asesor ID - ' + mensaje.asesorNumeroDocumento }}
          </strong>
          <time class="mensaje-fecha" [dateTime]="mensaje.fecha">{{ mensaje.fecha | date: 'hh:mm a' }}</time>
        </div>

        @switch (mensaje.tipoContenido) {
          @case ('text') {
            <p class="mensaje-texto">{{ mensaje.mensaje }}</p>
          }
          @case ('image') {
            <div class="mensaje-texto">
              <img
                class="imagen-miniatura"
                [src]="getMediaUrl(mensaje)"
                alt="Imagen enviada"
                loading="lazy"
                (load)="onImagenCargada()"
                (click)="abrirModal($event, getMediaUrl(mensaje), 'image')"
                role="button"
                tabindex="0"
                (keydown.enter)="abrirModal($event, getMediaUrl(mensaje), 'image')">
            </div>
          }
          @case ('audio') {
            <div class="mensaje-texto">
              <audio
                controls
                [src]="getMediaUrl(mensaje)"
                preload="metadata"
                aria-label="Audio mensaje">
              </audio>
            </div>
          }
          @case ('video') {
            <div class="mensaje-texto">
              <video
                class="video-miniatura"
                [src]="getMediaUrl(mensaje)"
                preload="metadata"
                muted
                playsinline
                (click)="abrirModal($event, getMediaUrl(mensaje), 'video')"
                (loadedmetadata)="onVideoLoaded($event)"
                aria-label="Video mensaje"
                role="button"
                tabindex="0"
                (keydown.enter)="abrirModal($event, getMediaUrl(mensaje), 'video')">
              </video>
            </div>
          }
        }
      </div>
    }
  </section>

  @if (modoSoloLectura) {
    <footer class="chat-input">
      <div class="conversacion-cerrada" role="status">
        Esta conversaciÃ³n se ha cerrado
      </div>
    </footer>
  } @else if (necesitaAsignarTipo) {
    <!-- AsignaciÃ³n de tipo en el footer -->
    <footer class="chat-input">
      <div class="asignar-tipo-container">
        <div class="asignar-tipo-mensaje">
          <p><strong>Este caso no tiene un tipo asignado</strong></p>
          <p>Por favor, selecciona un tipo para poder continuar con la conversaciÃ³n:</p>
        </div>
        <div class="asignar-tipo-form">
          <select
            class="tipo-select"
            [(ngModel)]="tipoSeleccionado"
            [disabled]="asignandoTipo"
            aria-label="Seleccionar tipo de caso">
            <option [ngValue]="null" disabled>Selecciona un tipo...</option>
            @for (tipo of tiposDisponibles; track tipo.id || tipo.nombre) {
              <option [ngValue]="tipo">{{ tipo.nombre }}</option>
            }
          </select>
          <button
            class="btn-asignar-tipo"
            (click)="asignarTipoACaso()"
            [disabled]="!tipoSeleccionado || asignandoTipo"
            aria-label="Asignar tipo">
            {{ asignandoTipo ? 'Asignando...' : 'Asignar Tipo' }}
          </button>
        </div>
      </div>
    </footer>
  } @else {
    <!-- Modo normal -->
    <footer class="chat-input">
      @if (archivoSeleccionado) {
        <div class="archivo-preview" role="status">
          <span>{{ archivoSeleccionado.name }}</span>
          <button
            (click)="cancelarArchivo()"
            aria-label="Cancelar archivo">âœ•</button>
        </div>
      }

      @if (grabandoAudio) {
        <div class="grabando-indicador" role="status">
          <span class="pulso" aria-hidden="true">ðŸ”´</span> Grabando audio... {{ tiempoGrabacion }}s
        </div>
      }

      <div class="input-row">
        <div class="input-wrapper">
          <input
            #inputImagen
            type="file"
            accept="image/*"
            (change)="seleccionarArchivo($event)"
            style="display: none;"
            aria-label="Seleccionar imagen">

          <button
            class="btn-icon"
            (click)="inputImagen.click()"
            [disabled]="grabandoAudio"
            aria-label="Enviar imagen">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>

          <button
            class="btn-icon"
            [class.grabando]="grabandoAudio"
            (click)="toggleGrabarAudio()"
            [attr.aria-label]="grabandoAudio ? 'Detener grabaciÃ³n' : 'Grabar audio'">
            @if (!grabandoAudio) {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            } @else {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <rect x="6" y="6" width="12" height="12" rx="1"/>
              </svg>
            }
          </button>

          <input
            type="text"
            [(ngModel)]="nuevoMensaje"
            (keyup.enter)="enviarMensaje()"
            placeholder="Escribe un mensaje..."
            [disabled]="grabandoAudio"
            aria-label="Mensaje de texto">
        </div>

        <div class="div-boton">
          <button
            class="btn-enviar"
            (click)="enviarMensaje()"
            [disabled]="grabandoAudio"
            aria-label="Enviar mensaje">
            Enviar
          </button>
        </div>
      </div>
    </footer>
  }
</article>

@if (modalAbierto) {
  <div
    class="modal-multimedia"
    (click)="cerrarModal()"
    role="dialog"
    aria-modal="true"
    aria-label="Vista previa de multimedia">
    <div class="modal-contenido" (click)="$event.stopPropagation()">
      <button
        class="btn-cerrar-modal"
        (click)="cerrarModal()"
        aria-label="Cerrar vista previa">âœ•</button>
      @if (modalTipo === 'image') {
        <img
          [src]="modalUrl"
          alt="Imagen ampliada"
          (click)="$event.stopPropagation()">
      }
      @if (modalTipo === 'video') {
        <video
          [src]="modalUrl"
          controls
          autoplay
          (click)="$event.stopPropagation()"
          aria-label="Video ampliado">
        </video>
      }
    </div>
  </div>
}
