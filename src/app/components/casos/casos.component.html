<div class="container-wrapper" [class.chat-abierto]="casoSeleccionado">
  <section class="container">
    <header class="header">
      <h2>Todas las conversaciones</h2>
      @if (tipoVista === 'en-proceso') {
        <button
          class="btn-new-chat"
          (click)="abrirModalNuevoChat()"
          aria-label="Nueva conversación">+</button>
      }
    </header>

    <div class="search-bar">
      <input
        type="search"
        class="lupa"
        placeholder="Buscar por celular"
        [(ngModel)]="filtro"
        (input)="filtrarCasos()"
        aria-label="Buscar conversación">
    </div>

    <div class="casos-lista" #casosLista>
      @if (casos.length === 0 && !cargandoMasCasos) {
        <p class="empty-message">{{ mensajeVacio }}</p>
      }

      @for (caso of casos; track caso.id) {
        <article
          class="chat-item"
          [class.chat-seleccionado]="casoSeleccionado?.id === caso.id"
          (click)="abrirChat(caso)"
          role="button"
          tabindex="0"
          (keydown.enter)="abrirChat(caso)"
          (keydown.space)="abrirChat(caso)">

          <div class="avatar">
            <img [src]="imagenAvatar" alt="Avatar de {{ caso.numeroUsuario }}" class="avatar-placeholder">
          </div>

          <div class="chat-content">
            <div class="chat-header">
              <div class="chat-title">
                <strong class="nombre">{{ obtenerTipo(caso) }} - {{ caso.numeroUsuario }}</strong>
              </div>
              <time class="hora">{{ obtenerHora(caso.id) }}</time>
            </div>

            @if (tipoVista === 'en-proceso') {
              <!-- Vista en-proceso -->
              <p class="chat-preview">
                <span class="ultimo-mensaje">Ultimo mensaje: {{ obtenerUltimoMensaje(caso.id) }}</span>
              </p>
              <div class="chat-status">
                <select
                  class="estado-select"
                  [(ngModel)]="caso.estado"
                  (change)="cambiarEstado($event, caso)"
                  (click)="$event.stopPropagation()"
                  aria-label="Estado del caso">
                  <option [value]="0" disabled>Sin atender</option>
                  <option [value]="1">En proceso</option>
                  <option [value]="2">Finalizado</option>
                </select>
              </div>
            } @else if (tipoVista === 'cerrados') {
              <!-- Vista cerrados -->
              <div class="chat-status">
                <span class="estado-cerrado">Finalizado</span>
              </div>
            }
          </div>

          @if (tipoVista === 'en-proceso' && (caso.estado === 0 || caso.mensajesNoLeidos > 0)) {
            <!-- Badge de notificación -->
            <span class="notification-badge" aria-label="Nuevas notificaciones"></span>
          }
        </article>
      }

      @if (cargandoMasCasos) {
        <!-- Indicador de carga -->
        <div class="loading-indicator" role="status">
          <div class="spinner"></div>
          <span>Cargando casos...</span>
        </div>
      }
    </div>
  </section>

  @if (casoSeleccionado) {
    <app-chat
      [caso]="casoSeleccionado"
      [modoSoloLectura]="esModoSoloLectura"
      (cerrar)="cerrarChat()"
      (nuevoMensajeRecibido)="actualizarUltimoMensaje($event)">
    </app-chat>
  }

  @if (mostrarModal) {
    <app-nueva-conversacion
      (cerrar)="cerrarModal()"
      (casoCreado)="onCasoCreado($event)">
    </app-nueva-conversacion>
  }
</div>
